<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Rust 新手错误和最差实践 | YiFei Zhang&#39;s Blog</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="stylesheet" href="https://cdn.bootcss.com/prism/9000.0.1/themes/prism.min.css">
    <link rel="stylesheet" href="https://cdn.bootcss.com/KaTeX/0.5.1/katex.min.css">
    <script charset="utf-8" src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async="true"></script>
    <link rel="icon" type="image/png" href="https://avatars2.githubusercontent.com/u/16968934?s=460&amp;v=4">
    <meta name="description" content="在这里了解我的一切，对编程的热爱永不停歇。">
    
    <link rel="preload" href="/assets/css/0.styles.0ff818ed.css" as="style"><link rel="preload" href="/assets/js/app.5abd99d6.js" as="script"><link rel="preload" href="/assets/js/11.05d3e33d.js" as="script"><link rel="preload" href="/assets/js/4.75c217d6.js" as="script"><link rel="preload" href="/assets/js/8.cabf8971.js" as="script"><link rel="preload" href="/assets/js/36.5ceb42fc.js" as="script"><link rel="preload" href="/assets/js/3.62f894e9.js" as="script"><link rel="prefetch" href="/assets/js/10.e1ca0b20.js"><link rel="prefetch" href="/assets/js/12.0132a1d0.js"><link rel="prefetch" href="/assets/js/13.9f313e03.js"><link rel="prefetch" href="/assets/js/14.f1465f38.js"><link rel="prefetch" href="/assets/js/15.4a99a300.js"><link rel="prefetch" href="/assets/js/16.3dc01d8e.js"><link rel="prefetch" href="/assets/js/17.ebea0b77.js"><link rel="prefetch" href="/assets/js/18.f122c89e.js"><link rel="prefetch" href="/assets/js/19.f33689d4.js"><link rel="prefetch" href="/assets/js/2.fe237bcd.js"><link rel="prefetch" href="/assets/js/20.aa204a72.js"><link rel="prefetch" href="/assets/js/21.7f4b0749.js"><link rel="prefetch" href="/assets/js/22.998ce568.js"><link rel="prefetch" href="/assets/js/23.b54edaf9.js"><link rel="prefetch" href="/assets/js/24.7c402c99.js"><link rel="prefetch" href="/assets/js/25.bddae6c1.js"><link rel="prefetch" href="/assets/js/26.8a6feb55.js"><link rel="prefetch" href="/assets/js/27.c04ec6b1.js"><link rel="prefetch" href="/assets/js/28.c9d0f7a5.js"><link rel="prefetch" href="/assets/js/29.facf7514.js"><link rel="prefetch" href="/assets/js/30.2a641e26.js"><link rel="prefetch" href="/assets/js/31.1d375557.js"><link rel="prefetch" href="/assets/js/32.c2d969f9.js"><link rel="prefetch" href="/assets/js/33.1d323e5d.js"><link rel="prefetch" href="/assets/js/34.3656ac05.js"><link rel="prefetch" href="/assets/js/35.5d1bec64.js"><link rel="prefetch" href="/assets/js/37.3667ae0d.js"><link rel="prefetch" href="/assets/js/38.4cc6e044.js"><link rel="prefetch" href="/assets/js/39.4724f8f3.js"><link rel="prefetch" href="/assets/js/40.eb4d5d7a.js"><link rel="prefetch" href="/assets/js/41.0bc4bcfe.js"><link rel="prefetch" href="/assets/js/42.3b7d5539.js"><link rel="prefetch" href="/assets/js/43.f46aed43.js"><link rel="prefetch" href="/assets/js/5.985cce7c.js"><link rel="prefetch" href="/assets/js/6.08f9588d.js"><link rel="prefetch" href="/assets/js/7.9aba82c0.js"><link rel="prefetch" href="/assets/js/9.d78be9b4.js">
    <link rel="stylesheet" href="/assets/css/0.styles.0ff818ed.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div><div class="header-wrap" data-v-33920667><div class="header page" data-v-33920667><div class="left" data-v-33920667><div class="motto" data-v-33920667></div> <div class="nav" data-v-33920667></div></div> <div class="right" data-v-33920667><div class="search-box" data-v-33920667><input aria-label="Search" placeholder="" autocomplete="off" spellcheck="false" value=""> <!----></div></div></div></div> <div class="page post-page"><div class="title"><div class="post-title">Rust 新手错误和最差实践</div></div> <div class="info"><div class="author">Yidadaa</div> <div class="date">2021/12/26</div> <div class="count"><span id="busuanzi_value_page_pv"></span> <span>views</span></div></div> <div class="post-content"><div class="content__default"><h1 id="rust-新手错误和最差实践"><a href="#rust-新手错误和最差实践" class="header-anchor">#</a> Rust 新手错误和最差实践</h1> <blockquote><p>原文：<a href="https://adventures.michaelfbryan.com/posts/rust-best-practices/bad-habits/#using-sentinel-values" target="_blank" rel="noopener noreferrer">Common Newbie Mistakes and Bad Practices in Rust: Bad Habits<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a><br>
译者：<a href="https://github.com/Yidadaa" target="_blank" rel="noopener noreferrer">Yidadaa<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <p>很多从其他语言过来的 Rust 新手都会不可避免地利用之前的编码经验来写 Rust，这无可厚非，毕竟确实没必要从头开始学习编程知识。但是，这些经验性知识，却极有可能导致你写出来很垃圾的 Rust 代码。</p> <h2 id="别再用哨兵值了"><a href="#别再用哨兵值了" class="header-anchor">#</a> 别再用哨兵值了</h2> <p>这可能是我最讨厌的一点。在大多数沿袭 C 语言设计的语言中（C，C#，Java 等），经常使用一个特殊值来表示某个函数执行失败的情况。比如，在 C# 中，用于在字符串中查找另一个字符串的索引位置的函数 <code>String.IndexOf(t)</code> 会在找不到 <code>t</code> 时返回 <code>-1</code>，从而写出这样的 C# 代码：</p> <div class="language-c# extra-class"><pre class="language-text"><code>string sentence = &quot;The fox jumps over the dog&quot;;

int index = sentence.IndexOf(&quot;fox&quot;);

if (index != -1)
{
  string wordsAfterFox = sentence.SubString(index);
  Console.WriteLine(wordsAfterFox);
}
</code></pre></div><p>在其他的语言中，这种用法更是数不胜数，类似的哨兵值还有空字符串 <code>&quot;&quot;</code> 或者 <code>null</code>、<code>None</code> 之类的空值。</p> <p>既然它这么常用，为什么还要说它很差劲呢？原因就是你极有可能会忘记处理哨兵值所代表的失败情况，然后导致整个程序直接崩溃。</p> <p>Rust 则提供了很好的解决方案，那就是 <code>Option</code>。<code>Option</code> 从设计层面就杜绝了忘记考虑 <code>None</code> 时的情况，编译器会在编译时就进行强制检查，如果你忘了处理 <code>None</code>，编译器会马上告诉你。上面字符串例子的代码，在 Rust 中可以写成这样：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> sentence <span class="token operator">=</span> <span class="token string">&quot;The fox jumps over the dog&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> index <span class="token operator">=</span> sentence<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">&quot;fox&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// let words_after_fox = &amp;sentence[index..];</span>
<span class="token comment">// 如果你直接使用 index，会得到报错：Error: Can't index str with Option&lt;usize&gt;</span>

<span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>fox<span class="token punctuation">)</span> <span class="token operator">=</span> index <span class="token punctuation">{</span>
  <span class="token keyword">let</span> words_after_fox <span class="token operator">=</span> <span class="token operator">&amp;</span>sentence<span class="token punctuation">[</span>fox<span class="token punctuation">..</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{}&quot;</span><span class="token punctuation">,</span> words_after_fox<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="别再用匈牙利命名了"><a href="#别再用匈牙利命名了" class="header-anchor">#</a> 别再用匈牙利命名了</h2> <p>上世纪 70 年代，程序员们逐渐开始在无类型或动态类型语言中使用<a href="https://en.wikipedia.org/wiki/Hungarian_notation" target="_blank" rel="noopener noreferrer">匈牙利命名法<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，他们给变量名加上不同的前缀来表示变量的类型，比如 <code>bVisited</code> 表示布尔型的变量 <code>visited</code>，<code>strName</code> 表示字符串类型的变量 <code>name</code>。</p> <p>我们可以在 <code>Delphi</code> 语言中见到大量的例子，<code>T</code> 开头的表示类（class）或者类型（type），<code>F</code> 表示属性值（fields），<code>A</code> 表示参数（arguments），诸如此类。</p> <div class="language-delphi extra-class"><pre class="language-text"><code>type
 TKeyValue = class
  private
    FKey: integer;
    FValue: TObject;
  public
    property Key: integer read FKey write FKey;
    property Value: TObject read FValue write FValue;
    function Frobnicate(ASomeArg: string): string;
  end;
</code></pre></div><p>C# 中也有类似的使用习惯，比如用 <code>I</code> 开头表示一个接口（interface），所以 C# 程序员很可能会写出这种 Rust 代码：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">trait</span> <span class="token type-definition class-name">IClone</span> <span class="token punctuation">{</span>
  <span class="token keyword">fn</span> <span class="token function-definition function">clone</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>你大可以直接扔掉前面的 <code>I</code>，因为 Rust 的语法已经保证了我们很难混淆 <code>trait</code> 和 <code>type</code>，不像 C# 很容易就分不清 <code>interface</code> 和 <code>class</code>（译者按：Typescript 中就是 <code>interface</code>、<code>type</code> 和 <code>class</code> 大混战了，狗头.jpg）。</p> <p>此外，你也没有必要在给一些工具函数或者中间变量命名时带上它的类型信息，比如下面的代码：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> account_bytes<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">u8</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token function">read_some_input</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> account_str <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from_utf8</span><span class="token punctuation">(</span>account_bytes<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> account<span class="token punctuation">:</span> <span class="token class-name">Account</span> <span class="token operator">=</span> account_str<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
</code></pre></div><p>既然 <code>String.from_utf8()</code> 已经明明白白地返回了一个字符串，为什么还要在命名时加上 <code>_str</code> 后缀呢？</p> <p>与其他语言不同，Rust 语言鼓励程序员在对变量进行一系列变换操作时，使用同名变量覆写掉不再使用的旧值，比如：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> account<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">u8</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token function">read_some_input</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> account <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from_utf8</span><span class="token punctuation">(</span>account<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> account<span class="token punctuation">:</span> <span class="token class-name">Account</span> <span class="token operator">=</span> account<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
</code></pre></div><p>使用相同的变量名可以很好地保证概念的一致性。</p> <p>有些语言会明令禁止<a href="https://rules.sonarsource.com/cpp/RSPEC-1117" target="_blank" rel="noopener noreferrer">覆写变量<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，尤其像 Javascript 这种动态类型语言，因为频繁变化的类型，在缺少类型推断的情况下，尤其有可能会导致 bug 出现。</p> <h2 id="你可能不需要这么多-rc-refcell-t"><a href="#你可能不需要这么多-rc-refcell-t" class="header-anchor">#</a> 你可能不需要这么多 <code>Rc&lt;RefCell&lt;T&gt;&gt;</code></h2> <p>OOP 编程实践常常会保存其他对象的引用，并在合适的时候调用他们的函数，这没啥不好的，依赖注入（Dependency Injection）是个蛮不错的实践，不过有别于大多数面向对象的语言，Rust 并没有垃圾内存回收机制（Garbage Collector），并且对共享可变性非常敏感。</p> <p>举个例子，我们正要实现一个打怪兽的游戏，玩家需要对怪物们造成足量伤害才算打败他们（我也不知道为什么要这么设定，可能是接受了什么委托？）。</p> <p>先创建一个 <code>Monster</code> 类，包含 <code>health</code> 生命值属性以及 <code>takeDamage()</code> 遭受伤害的方法，为了能知道怪物遭受了多少伤害，我们允许为 <code>Monster</code> 类注入一个回调函数，该回调函数可以接收每次遭受的伤害值。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">type</span> <span class="token class-name">OnReceivedDamage</span> <span class="token operator">=</span> <span class="token punctuation">(</span>damageReceived<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Monster</span> <span class="token punctuation">{</span>
  health<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">;</span>
  receivedDamage<span class="token operator">:</span> OnReceivedDamage<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token function">takeDamage</span><span class="token punctuation">(</span>amount<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    amount <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>health<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>health <span class="token operator">-=</span> amount<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>receivedDamage<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">cb</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">on</span><span class="token punctuation">(</span>event<span class="token operator">:</span> <span class="token string">&quot;damaged&quot;</span><span class="token punctuation">,</span> callback<span class="token operator">:</span> OnReceivedDamage<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>receivedDamage<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>然后设计一个伤害计数类 <code>DamageCounter</code>，可以累计怪物伤害值：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">class</span> <span class="token class-name">DamageCounter</span> <span class="token punctuation">{</span>
  damageInflicted<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token function">reachedTargetDamage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>damageInflicted <span class="token operator">&gt;</span> <span class="token number">100</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">onDamageInflicted</span><span class="token punctuation">(</span>amount<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>damageInflicted <span class="token operator">+=</span> amount<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>然后我们对怪物造成随机伤害，直到伤害计数达到上限。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> counter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DamageCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> monsters <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token keyword">new</span> <span class="token class-name">Monster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">new</span> <span class="token class-name">Monster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">new</span> <span class="token class-name">Monster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">new</span> <span class="token class-name">Monster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">new</span> <span class="token class-name">Monster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
monsters<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
  m<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;damaged&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>amount<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> counter<span class="token punctuation">.</span><span class="token function">onDamageInflicted</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>counter<span class="token punctuation">.</span><span class="token function">reachedTargetDamage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 随机选中怪物</span>
  <span class="token keyword">const</span> index <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> monsters<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> target <span class="token operator">=</span> monsters<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">// 产生随机伤害</span>
  <span class="token keyword">const</span> damage <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  target<span class="token punctuation">.</span><span class="token function">takeDamage</span><span class="token punctuation">(</span>damage<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Monster </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>index<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> received </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>damage<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> damage</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里是<a href="https://www.typescriptlang.org/play?#code/C4TwDgpgBA8gdgJQgYwgSwG4QCYBECGAtvgObQC8UAFIQFxQCyA9nAM7AQBOANFNkaQhJUmHPTgBXQgCMuASijkAfFAxM02ANwAobcgA2+Vq0Yt2XKAG9tUW1AAWEfPuD3xU2Z0VQArAAYdOyhOFHQsPAEyenhhMJwCYjIAbQBdb1SdGztgfABrCATBKiImCThgdxl5Kyyg2xKy4G8GfFcAOkI0OCpXNFY2x2dXXgbyuUC6217+wZd7KABaSlHgTTrauum2kJFwwrI2gDMmTgBRfGR7KmRpRRUbnvs+kcJSsfGNgF9dIJYqCCw5XoACJ+IkcMDeMhnPppBdctFEKFRBFwXJ6GoNDVJlMnv0dnFUYI2mAJKwrtD9LD4R8gt9vnpDMYoPsIABhN4cLzWIJgwQASTgh30aGQHGwlU83gCPzsIQujmwABV8JwyMBWVR0VBpEwmPonHBsTiQsAJJwjVs+WRBcLReKoCoAIx+GV02W2Fis20isU4YqvRqS6o8nFWyIQH32nBQADUy0D5QmtnpumQZia6caFkocAgAHcWRGOdnOFrMum2E1XlWuCZKEk84XmLWy3JeE3TK2tR2C13zG3e82M1we1BOy2B1qUjoawP+sczgqaHcoIQ2n9QRHsJDqAB9F6chTKKBZ8pcDdwb1C33igNHuQfbT5p4G6gAQjPXO2TkuOBVaoQBqEZagooa2AA9BBUBgKKuRQPgwT4HA2BMIQa4jpwGyVuwUBdNgEAAB7NK09hHPoepli07ScMhqGEFqABUc5cv0BpwCQri0nYOFNDkgFNJQLF1kk+FETOGxQVArgQEa1rQGgTSIdIinYRmfARiRNFvNgVDUWRtEoWhWpQIxvh+NxUyquqbQ5PkmryU+QQ4fqEBtBRJBUAABpOXJQAAJJYYmEZ8wTIuEAWWPJoXydQwBMDk+gaeCeE3tGEqRV+F7yVGfrYJ8XkfJ8QA" target="_blank" rel="noopener noreferrer">在线运行示例<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>然后我们用 Rust 重写上述逻辑，<code>Monster</code> 结构体结构保持不变，使用 <code>Box&lt;dyn Fn(u32)&gt;</code> 来接收闭包，该闭包接受一个 <code>u32</code> 型参数。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">type</span> <span class="token type-definition class-name">OnReceivedDamage</span> <span class="token operator">=</span> <span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token keyword">dyn</span> <span class="token class-name">Fn</span><span class="token punctuation">(</span><span class="token keyword">u32</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">Monster</span> <span class="token punctuation">{</span>
    health<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
    received_damage<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">OnReceivedDamage</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Monster</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">take_damage</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> amount<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> damage_received <span class="token operator">=</span> <span class="token namespace">cmp<span class="token punctuation">::</span></span><span class="token function">min</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>health<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>health <span class="token operator">-=</span> damage_received<span class="token punctuation">;</span>
        <span class="token keyword">for</span> callback <span class="token keyword">in</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">.</span>received_damage <span class="token punctuation">{</span>
            <span class="token function">callback</span><span class="token punctuation">(</span>damage_received<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">add_listener</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> listener<span class="token punctuation">:</span> <span class="token class-name">OnReceivedDamage</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>received_damage<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Default</span> <span class="token keyword">for</span> <span class="token class-name">Monster</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span> <span class="token punctuation">{</span>
        <span class="token class-name">Monster</span> <span class="token punctuation">{</span> health<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span> received_damage<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>随后是 <code>DamageCounter</code> 类：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token attribute attr-name">#[derive(Default)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">DamageCounter</span> <span class="token punctuation">{</span>
    damage_inflicted<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">DamageCounter</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">reached_target_damage</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">bool</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>damage_inflicted <span class="token operator">&gt;</span> <span class="token number">100</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">on_damage_received</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> damage<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>damage_inflicted <span class="token operator">+=</span> damage<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>然后开始打怪：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> rng <span class="token operator">=</span> <span class="token namespace">rand<span class="token punctuation">::</span></span><span class="token function">thread_rng</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> counter <span class="token operator">=</span> <span class="token class-name">DamageCounter</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> monsters<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span>_<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">..</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>_<span class="token closure-punctuation punctuation">|</span></span> <span class="token class-name">Monster</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> monster <span class="token keyword">in</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> monsters <span class="token punctuation">{</span>
        monster<span class="token punctuation">.</span><span class="token function">add_listener</span><span class="token punctuation">(</span><span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>damage<span class="token closure-punctuation punctuation">|</span></span> counter<span class="token punctuation">.</span><span class="token function">on_damage_received</span><span class="token punctuation">(</span>damage<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">while</span> <span class="token operator">!</span>counter<span class="token punctuation">.</span><span class="token function">reached_target_damage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> index <span class="token operator">=</span> rng<span class="token punctuation">.</span><span class="token function">gen_range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">..</span>monsters<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> target <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> monsters<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> damage <span class="token operator">=</span> rng<span class="token punctuation">.</span><span class="token function">gen_range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">..</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        target<span class="token punctuation">.</span><span class="token function">take_damage</span><span class="token punctuation">(</span>damage<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Monster {} received {} damage&quot;</span><span class="token punctuation">,</span> index<span class="token punctuation">,</span> damage<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>同样地，Rust 代码也有一个<a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=a8cc547728ef102bbd5dc6b9cafb0ff6" target="_blank" rel="noopener noreferrer">在线运行示例<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>然而，编译器狠狠地给我们报了四个错误，全都集中在 <code>monster.add_listener()</code> 这一行：</p> <div class="language-rust extra-class"><pre class="language-rust"><code>error<span class="token punctuation">[</span><span class="token constant">E0596</span><span class="token punctuation">]</span><span class="token punctuation">:</span> cannot borrow `counter` <span class="token keyword">as</span> mutable<span class="token punctuation">,</span> <span class="token keyword">as</span> it is a captured variable <span class="token keyword">in</span> a `<span class="token class-name">Fn</span>` closure
  <span class="token operator">-</span><span class="token punctuation">-&gt;</span> src<span class="token operator">/</span>main<span class="token punctuation">.</span>rs<span class="token punctuation">:</span><span class="token number">47</span><span class="token punctuation">:</span><span class="token number">48</span>
   <span class="token operator">|</span>
<span class="token number">47</span> <span class="token operator">|</span>         monster<span class="token punctuation">.</span><span class="token function">add_listener</span><span class="token punctuation">(</span><span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>damage<span class="token closure-punctuation punctuation">|</span></span> counter<span class="token punctuation">.</span><span class="token function">on_damage_received</span><span class="token punctuation">(</span>damage<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token operator">|</span>                                                <span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span> cannot borrow <span class="token keyword">as</span> mutable

error<span class="token punctuation">[</span><span class="token constant">E0499</span><span class="token punctuation">]</span><span class="token punctuation">:</span> cannot borrow `counter` <span class="token keyword">as</span> mutable more than once at a time
  <span class="token operator">-</span><span class="token punctuation">-&gt;</span> src<span class="token operator">/</span>main<span class="token punctuation">.</span>rs<span class="token punctuation">:</span><span class="token number">47</span><span class="token punctuation">:</span><span class="token number">39</span>
   <span class="token operator">|</span>
<span class="token number">47</span> <span class="token operator">|</span>         monster<span class="token punctuation">.</span><span class="token function">add_listener</span><span class="token punctuation">(</span><span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>damage<span class="token closure-punctuation punctuation">|</span></span> counter<span class="token punctuation">.</span><span class="token function">on_damage_received</span><span class="token punctuation">(</span>damage<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token operator">|</span>                              <span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
   <span class="token operator">|</span>                              <span class="token operator">|</span>        <span class="token operator">|</span>        <span class="token operator">|</span>
   <span class="token operator">|</span>                              <span class="token operator">|</span>        <span class="token operator">|</span>        borrows occur due to <span class="token keyword">use</span> of `counter` <span class="token keyword">in</span> closure
   <span class="token operator">|</span>                              <span class="token operator">|</span>        `counter` was mutably borrowed here <span class="token keyword">in</span> the previous iteration of the <span class="token keyword">loop</span>
   <span class="token operator">|</span>                              cast requires that `counter` is borrowed <span class="token keyword">for</span> `<span class="token lifetime-annotation symbol">'static</span>`

error<span class="token punctuation">[</span><span class="token constant">E0597</span><span class="token punctuation">]</span><span class="token punctuation">:</span> `counter` does not live long enough
  <span class="token operator">-</span><span class="token punctuation">-&gt;</span> src<span class="token operator">/</span>main<span class="token punctuation">.</span>rs<span class="token punctuation">:</span><span class="token number">47</span><span class="token punctuation">:</span><span class="token number">48</span>
   <span class="token operator">|</span>
<span class="token number">47</span> <span class="token operator">|</span>         monster<span class="token punctuation">.</span><span class="token function">add_listener</span><span class="token punctuation">(</span><span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>damage<span class="token closure-punctuation punctuation">|</span></span> counter<span class="token punctuation">.</span><span class="token function">on_damage_received</span><span class="token punctuation">(</span>damage<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token operator">|</span>                              <span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
   <span class="token operator">|</span>                              <span class="token operator">|</span>        <span class="token operator">|</span>        <span class="token operator">|</span>
   <span class="token operator">|</span>                              <span class="token operator">|</span>        <span class="token operator">|</span>        borrowed value does not live long enough
   <span class="token operator">|</span>                              <span class="token operator">|</span>        value captured here
   <span class="token operator">|</span>                              cast requires that `counter` is borrowed <span class="token keyword">for</span> `<span class="token lifetime-annotation symbol">'static</span>`
<span class="token punctuation">...</span>
<span class="token number">60</span> <span class="token operator">|</span> <span class="token punctuation">}</span>
   <span class="token operator">|</span> <span class="token operator">-</span> `counter` dropped here <span class="token keyword">while</span> still borrowed

error<span class="token punctuation">[</span><span class="token constant">E0502</span><span class="token punctuation">]</span><span class="token punctuation">:</span> cannot borrow `counter` <span class="token keyword">as</span> immutable because it is also borrowed <span class="token keyword">as</span> mutable
  <span class="token operator">-</span><span class="token punctuation">-&gt;</span> src<span class="token operator">/</span>main<span class="token punctuation">.</span>rs<span class="token punctuation">:</span><span class="token number">50</span><span class="token punctuation">:</span><span class="token number">12</span>
   <span class="token operator">|</span>
<span class="token number">47</span> <span class="token operator">|</span>         monster<span class="token punctuation">.</span><span class="token function">add_listener</span><span class="token punctuation">(</span><span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>damage<span class="token closure-punctuation punctuation">|</span></span> counter<span class="token punctuation">.</span><span class="token function">on_damage_received</span><span class="token punctuation">(</span>damage<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token operator">|</span>                              <span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
   <span class="token operator">|</span>                              <span class="token operator">|</span>        <span class="token operator">|</span>        <span class="token operator">|</span>
   <span class="token operator">|</span>                              <span class="token operator">|</span>        <span class="token operator">|</span>        first borrow occurs due to <span class="token keyword">use</span> of `counter` <span class="token keyword">in</span> closure
   <span class="token operator">|</span>                              <span class="token operator">|</span>        mutable borrow occurs here
   <span class="token operator">|</span>                              cast requires that `counter` is borrowed <span class="token keyword">for</span> `<span class="token lifetime-annotation symbol">'static</span>`
<span class="token punctuation">...</span>
<span class="token number">50</span> <span class="token operator">|</span>     <span class="token keyword">while</span> <span class="token operator">!</span>counter<span class="token punctuation">.</span><span class="token function">reached_target_damage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token operator">|</span>            <span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span> immutable borrow occurs here
</code></pre></div><p>看起来是一团乱麻，让我来翻译翻译<del>，什么叫惊喜</del>：</p> <ul><li>闭包捕获了对 <code>counter</code> 的引用；</li> <li><code>counter.on_damage_received()</code> 方法接受 <code>&amp;mut self</code>，所以闭包需要 <code>&amp;mut</code> 可变引用。由于这个闭包在循环里，所以对同一个对象的可变引用 <code>&amp;mut</code> 会执行多次，这是不被 Rust 允许的；</li> <li>我们传入的闭包没有任何生命周期标记，意味着它需要掌控所有包含变量的所有权，所以 <code>counter</code> 需要被移动到闭包内部，而在循环中，重复移动某值就会造成 <code>use of moved value</code> 错误；</li> <li>当 <code>counter</code> 被移动到闭包内后，我们又尝试在条件语句中使用它，显然也会报错。</li></ul> <p>总之，情况不太妙。</p> <p>一个经典解决方法是把 <code>DamageCounter</code> 用引用计数指针裹起来，这样我们可以重复使用它了，此外由于我们需要使用 <code>&amp;mut self</code>，所以我们需要使用 <code>RefCell</code> 来在运行时做借用检查（borrow checking），而不是在编译时。</p> <div class="language-diff extra-class"><pre class="language-diff"><code><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">fn main() {
</span><span class="token prefix unchanged"> </span><span class="token line">    let mut rng = rand::thread_rng();
</span></span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">    let mut counter = DamageCounter::default();
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">    let mut counter = Rc::new(RefCell::new(DamageCounter::default()));
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">    let mut monsters: Vec&lt;_&gt; = (0..5).map(|_| Monster::default()).collect();
</span></span>
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">    for monster in &amp;mut monsters {
</span></span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">        monster.add_listener(Box::new(|damage| counter.on_damage_received(damage)));
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">        let counter = Rc::clone(&amp;counter);
</span><span class="token prefix inserted">+</span><span class="token line">        monster.add_listener(Box::new(move |damage| {
</span><span class="token prefix inserted">+</span><span class="token line">            counter.borrow_mut().on_damage_received(damage)
</span><span class="token prefix inserted">+</span><span class="token line">        }));
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">    }
</span></span>
<span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">    while !counter.reached_target_damage() {
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">    while !counter.borrow().reached_target_damage() {
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">        let index = rng.gen_range(0..monsters.len());
</span><span class="token prefix unchanged"> </span><span class="token line">        let target = &amp;mut monsters[index];
</span><span class="token prefix unchanged"> </span><span class="token line">        ...
</span><span class="token prefix unchanged"> </span><span class="token line">    }
</span><span class="token prefix unchanged"> </span><span class="token line">}
</span></span></code></pre></div><p>这里是<a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=7aca92432f337fa29de62999ea5709b8" target="_blank" rel="noopener noreferrer">改动后的代码<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>虽然现在代码可以正常运行了，但是整块代码会被 <code>Rc&lt;RefCell&gt;Vec&lt;Foo&gt;&gt;&gt;</code> 之类的玩意儿搞得乌烟瘴气。而且当代码变得更复杂时，<code>RefCell</code> 也有可能会被可变借用多次。而如果在多线程中使用了 <code>Arc&lt;Mutex&lt;Vec&lt;Foo&gt;&gt;&gt;</code>，<code>RefCell</code> 引发 panic 之后，整个程序会死锁。</p> <p>所以，一个更好的解决方法是避免在结构体中存储持久化引用。我们对 <code>Monster::take_damage()</code> 稍加改造：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">struct</span> <span class="token type-definition class-name">Monster</span> <span class="token punctuation">{</span>
    health<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Monster</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">take_damage</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> amount<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span> on_damage_received<span class="token punctuation">:</span> <span class="token keyword">impl</span> <span class="token class-name">FnOnce</span><span class="token punctuation">(</span><span class="token keyword">u32</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> damage_received <span class="token operator">=</span> <span class="token namespace">cmp<span class="token punctuation">::</span></span><span class="token function">min</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>health<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>health <span class="token operator">-=</span> damage_received<span class="token punctuation">;</span>
        <span class="token function">on_damage_received</span><span class="token punctuation">(</span>damage_received<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Default</span> <span class="token keyword">for</span> <span class="token class-name">Monster</span> <span class="token punctuation">{</span>
  <span class="token keyword">fn</span> <span class="token function-definition function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span> <span class="token punctuation">{</span> <span class="token class-name">Monster</span> <span class="token punctuation">{</span> health<span class="token punctuation">:</span> <span class="token number">100</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 省略了 `DamageCounter` 的代码</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> rng <span class="token operator">=</span> <span class="token namespace">rand<span class="token punctuation">::</span></span><span class="token function">thread_rng</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> counter <span class="token operator">=</span> <span class="token class-name">DamageCounter</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> monsters<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span>_<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">..</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>_<span class="token closure-punctuation punctuation">|</span></span> <span class="token class-name">Monster</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token operator">!</span>counter<span class="token punctuation">.</span><span class="token function">reached_target_damage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> index <span class="token operator">=</span> rng<span class="token punctuation">.</span><span class="token function">gen_range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">..</span>monsters<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> target <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> monsters<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> damage <span class="token operator">=</span> rng<span class="token punctuation">.</span><span class="token function">gen_range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">..</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        target<span class="token punctuation">.</span><span class="token function">take_damage</span><span class="token punctuation">(</span>damage<span class="token punctuation">,</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>dmg<span class="token closure-punctuation punctuation">|</span></span> counter<span class="token punctuation">.</span><span class="token function">on_damage_received</span><span class="token punctuation">(</span>dmg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Monster {} received {} damage&quot;</span><span class="token punctuation">,</span> index<span class="token punctuation">,</span> damage<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里是<a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=52b789a7616efe6c2e24b7e1949f7c03" target="_blank" rel="noopener noreferrer">在线示例<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>由于避免了存储回调函数，改造后的代码行数从 62 行下降到了 47 行。</p> <p>此外，我们也可以给 <code>take_damage()</code> 加个返回值，这样可以把伤害值放在返回值里，以备后用：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">impl</span> <span class="token class-name">Monster</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">take_damage</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> amount<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">AttackSummary</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> damage_received <span class="token operator">=</span> <span class="token namespace">cmp<span class="token punctuation">::</span></span><span class="token function">min</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>health<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>health <span class="token operator">-=</span> damage_received<span class="token punctuation">;</span>
        <span class="token class-name">AttackSummary</span> <span class="token punctuation">{</span> damage_received <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">AttackSummary</span> <span class="token punctuation">{</span>
    damage_received<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">// 省略了 `DamageCounter` 的代码</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> rng <span class="token operator">=</span> <span class="token namespace">rand<span class="token punctuation">::</span></span><span class="token function">thread_rng</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> counter <span class="token operator">=</span> <span class="token class-name">DamageCounter</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> monsters<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span>_<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">..</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>_<span class="token closure-punctuation punctuation">|</span></span> <span class="token class-name">Monster</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token operator">!</span>counter<span class="token punctuation">.</span><span class="token function">reached_target_damage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> index <span class="token operator">=</span> rng<span class="token punctuation">.</span><span class="token function">gen_range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">..</span>monsters<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> target <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> monsters<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> damage <span class="token operator">=</span> rng<span class="token punctuation">.</span><span class="token function">gen_range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">..</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token class-name">AttackSummary</span> <span class="token punctuation">{</span> damage_received <span class="token punctuation">}</span> <span class="token operator">=</span> target<span class="token punctuation">.</span><span class="token function">take_damage</span><span class="token punctuation">(</span>damage<span class="token punctuation">)</span><span class="token punctuation">;</span>
        counter<span class="token punctuation">.</span><span class="token function">on_damage_received</span><span class="token punctuation">(</span>damage_received<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Monster {} received {} damage&quot;</span><span class="token punctuation">,</span> index<span class="token punctuation">,</span> damage<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>当代码复杂度上升时，代码也不会变成一团糟，而且它看起来更“函数式”。</p> <h2 id="错用整数类型"><a href="#错用整数类型" class="header-anchor">#</a> 错用整数类型</h2> <p>另一个从 C 语言带来的坏毛病是错用整数类型，导致代码里到处都是 <code>usize</code> 的类型转换，尤其是在对数组做索引时。</p> <p>C 程序员在初学时就被各种教程教会了使用 <code>int</code> 类型来做索引和循环，当他们开始写 Rust 时，也自然而然地用 <code>Vec&lt;i32&gt;</code> 类型来做数组切片。但是阿 Rust 真的很严格，不让程序员使用 <code>usize</code> 以外的类型对数组、切片和 <code>Vec</code> 进行索引，这就不得不在索引的时候进行一次 <code>i32 as usize</code> 的类型转换。</p> <p>Rust 这么做有诸多好处：</p> <ul><li>无符号类型可以避免负数索引（译者按：Python 程序员请求出战）；</li> <li><code>usize</code> 与普通指针的大小相同，指针运算不会造成隐式类型转换；</li> <li>内存操作函数 <code>std::mem::size_of()</code> 和 <code>std::mem::align_of()</code> 返回 <code>usize</code> 类型。</li></ul> <p>所以，请尽量使用 <code>usize</code> 类型作为可能涉及索引操作的中间变量的首选类型。</p> <h2 id="没人比我更懂-unsafe"><a href="#没人比我更懂-unsafe" class="header-anchor">#</a> 没人比我更懂 <code>unsafe</code></h2> <p>每次当我看到 C 程序员使用 <code>std::mem::transmute()</code> 函数或者裸指针来跳过编译器的借用检查时，我都会想起论坛中那条古老的 Rust 圣经：<a href="https://users.rust-lang.org/t/rust-koans/2408?u=michael-f-bryan" target="_blank" rel="noopener noreferrer">Obstacles, by Daniel Keep<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>建议你现在就去读一读，我可以等。（译者按：有空了给大伙翻译一下。）</p> <p>你可能已经身经百战见得多了，精通八种编程语言，所以毫无顾忌地破坏 Rust 精心构筑的规则：创建自引用的结构体、用 <code>unsafe</code> 创建全局变量。而且每一次，你都用同样的借口：“这是个单线程程序，所以 <code>static mut</code> 百分之一万没问题”、“这在 C 语言里跑得好好的”。</p> <p><code>unsafe</code> 很微妙，你必须要对 Rust 的借用检查规则和内存模型有深刻的认识才行。我也不想像祥林嫂一样念叨：“未成年人请在编译器监督下编写 <code>unsafe</code> 多线程代码”，但如果你刚开始学这门语言，我衷心建议你耐心从编译器报错的痛苦中慢慢品味 Rust 的美妙。</p> <p>当你成为了 Rust 大师，你可以尽情玩弄 <code>unsafe</code> 代码，但在那之前，我还是想告诉你，<code>unsafe</code> 不是杀死编译器报错的板蓝根，也不是能让你自在书写 C 风味 Rust 代码的作弊码。</p> <h2 id="不舍得用命名空间"><a href="#不舍得用命名空间" class="header-anchor">#</a> 不舍得用命名空间</h2> <p>C 语言中的另一个常见实践是给函数增加所属的库名或者模块名作为前缀，比如 <code>rune_wasmer_runtime_load()</code> 就表示 <code>rune</code> 库的 <code>wasmer/runtime</code> 模块下的 <code>load()</code> 函数。Rust 提供了非常好用的命名空间机制，请尽情使用它，比如刚刚这个函数就可以写成 <code>rune::wasmer::Runtime::load()</code>。</p> <h2 id="滥用切片索引"><a href="#滥用切片索引" class="header-anchor">#</a> 滥用切片索引</h2> <p>C 语言离不开 <code>for (int i = 0; i &lt; n; i ++)</code>，就像西方不能没有耶路撒冷。</p> <p>所以下面的 Rust 的代码也就不足为奇：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> points<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Coordinate</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">...</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> differences <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token number">1</span><span class="token punctuation">..</span>points<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">[</span>
  <span class="token keyword">let</span> current <span class="token operator">=</span> points<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> previous <span class="token operator">=</span> points<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  differences<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>current <span class="token operator">-</span> previous<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">]</span>
</code></pre></div><p>就像呼吸一样自然。然而，就算是老司机也难免会中招下标越界 bug ，尤其当你想在循环里取前一个值时，你就得花心思去考虑 <code>i</code> 是否是从 1 开始的。</p> <p>Rust 很担心你，所以拿出了迭代器，切片类型甚至还有 <code>windows()</code> 和 <code>array_windows()</code> 这种高级函数来获取相邻的元素对。上面的代码可以重写为：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> points<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Coordinate</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">...</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> <span class="token keyword">mut</span> differences <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">[</span>previous<span class="token punctuation">,</span> current<span class="token punctuation">]</span> <span class="token keyword">in</span> points<span class="token punctuation">.</span><span class="token function">array_windows</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">copied</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  differences<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>current <span class="token operator">-</span> previous<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>甚至可以用链式调用来炫技：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> differences<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span>_<span class="token operator">&gt;</span> <span class="token operator">=</span> points
  <span class="token punctuation">.</span><span class="token function">array_windows</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">copied</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token punctuation">[</span>previous<span class="token punctuation">,</span> current<span class="token punctuation">]</span><span class="token closure-punctuation punctuation">|</span></span> current <span class="token operator">-</span> previous<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>有些人会主张使用了 <code>map()</code> 和 <code>collect</code> 版本的代码更加“函数式“，我则觉得仁者见仁，智者见智。</p> <p>不仅如此，迭代器的性能往往比朴素的 <code>for</code> 循环更好，你可以在<a href="https://users.rust-lang.org/t/we-all-know-iter-is-faster-than-loop-but-why/51486/7?u=michael-f-bryan" target="_blank" rel="noopener noreferrer">这里<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>了解原因。</p> <h2 id="滥用迭代器"><a href="#滥用迭代器" class="header-anchor">#</a> 滥用迭代器</h2> <p>一旦你用迭代器用上瘾了，你极有可能跑向对立面：拿着迭代器这个锤子，看啥都像钉子。由 <code>map</code>，<code>filter</code> 和 <code>and_then()</code> 堆叠成的链式调用会让代码可读性下降，而且频繁使用闭包，会让数据类型变得不再直观。</p> <p>下面有个例子，演示了迭代器如何让你的代码变得更复杂，你可以读一读这段代码，并猜猜它是干啥的：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">functional_blur</span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Matrix</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Matrix</span> <span class="token punctuation">{</span>
    <span class="token macro property">assert!</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span>width <span class="token operator">&gt;=</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">assert!</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span>height <span class="token operator">&gt;=</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 先保存首尾两行，方便后续使用</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> rows <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">rows</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> first_row <span class="token operator">=</span> rows<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> last_row <span class="token operator">=</span> rows<span class="token punctuation">.</span><span class="token function">next_back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> top_row <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">rows</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> middle_row <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">rows</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">skip</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> bottom_row <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">rows</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">skip</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> blurred_elements <span class="token operator">=</span> top_row
        <span class="token punctuation">.</span><span class="token function">zip</span><span class="token punctuation">(</span>middle_row<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">zip</span><span class="token punctuation">(</span>bottom_row<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">flat_map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token punctuation">(</span><span class="token punctuation">(</span>top<span class="token punctuation">,</span> middle<span class="token punctuation">)</span><span class="token punctuation">,</span> bottom<span class="token punctuation">)</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token function">blur_rows</span><span class="token punctuation">(</span>top<span class="token punctuation">,</span> middle<span class="token punctuation">,</span> bottom<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> elements<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">f32</span><span class="token operator">&gt;</span> <span class="token operator">=</span> first_row
        <span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">copied</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">chain</span><span class="token punctuation">(</span>blurred_elements<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">chain</span><span class="token punctuation">(</span>last_row<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">copied</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Matrix</span><span class="token punctuation">::</span><span class="token function">new_row_major</span><span class="token punctuation">(</span>elements<span class="token punctuation">,</span> input<span class="token punctuation">.</span>width<span class="token punctuation">,</span> input<span class="token punctuation">.</span>height<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">blur_rows</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
    top_row<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token punctuation">[</span><span class="token keyword">f32</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    middle_row<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token punctuation">[</span><span class="token keyword">f32</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    bottom_row<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token punctuation">[</span><span class="token keyword">f32</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">impl</span> <span class="token class-name">Iterator</span><span class="token operator">&lt;</span><span class="token class-name">Item</span> <span class="token operator">=</span> <span class="token keyword">f32</span><span class="token operator">&gt;</span> <span class="token operator">+</span> <span class="token lifetime-annotation symbol">'a</span> <span class="token punctuation">{</span>
    <span class="token comment">// 保存头尾元素，以备后用</span>
    <span class="token keyword">let</span> <span class="token operator">&amp;</span>first <span class="token operator">=</span> middle_row<span class="token punctuation">.</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token operator">&amp;</span>last <span class="token operator">=</span> middle_row<span class="token punctuation">.</span><span class="token function">last</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 获取上中下的 3x3 矩阵来做平均</span>
    <span class="token keyword">let</span> top_window <span class="token operator">=</span> top_row<span class="token punctuation">.</span><span class="token function">windows</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> middle_window <span class="token operator">=</span> middle_row<span class="token punctuation">.</span><span class="token function">windows</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> bottom_window <span class="token operator">=</span> bottom_row<span class="token punctuation">.</span><span class="token function">windows</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 滑动窗口取均值，除了首尾元素</span>
    <span class="token keyword">let</span> averages <span class="token operator">=</span> top_window
        <span class="token punctuation">.</span><span class="token function">zip</span><span class="token punctuation">(</span>middle_window<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">zip</span><span class="token punctuation">(</span>bottom_window<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token punctuation">(</span><span class="token punctuation">(</span>top<span class="token punctuation">,</span> middle<span class="token punctuation">)</span><span class="token punctuation">,</span> bottom<span class="token punctuation">)</span><span class="token closure-punctuation punctuation">|</span></span> top<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chain</span><span class="token punctuation">(</span>middle<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chain</span><span class="token punctuation">(</span>bottom<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token keyword">f32</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">9.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token namespace">std<span class="token punctuation">::</span>iter<span class="token punctuation">::</span></span><span class="token function">once</span><span class="token punctuation">(</span>first<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">chain</span><span class="token punctuation">(</span>averages<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">chain</span><span class="token punctuation">(</span><span class="token namespace">std<span class="token punctuation">::</span>iter<span class="token punctuation">::</span></span><span class="token function">once</span><span class="token punctuation">(</span>last<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p><a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=da8fa6e55ca5a0de6005b13672688c14" target="_blank" rel="noopener noreferrer">在线示例<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>看起来好像并不难，做个均值滤波罢了，不过我这里有个更好的实现：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">imperative_blur</span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Matrix</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Matrix</span> <span class="token punctuation">{</span>
    <span class="token macro property">assert!</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span>width <span class="token operator">&gt;=</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">assert!</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span>height <span class="token operator">&gt;=</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 直接从输入值拷贝返回值矩阵，这样就不需要考虑边界条件</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> output <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> y <span class="token keyword">in</span> <span class="token number">1</span><span class="token punctuation">..</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span>height <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token number">1</span><span class="token punctuation">..</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span>width <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> <span class="token keyword">mut</span> pixel_value <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>

            pixel_value <span class="token operator">+=</span> input<span class="token punctuation">[</span><span class="token punctuation">[</span>x <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> y <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            pixel_value <span class="token operator">+=</span> input<span class="token punctuation">[</span><span class="token punctuation">[</span>x<span class="token punctuation">,</span> y <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            pixel_value <span class="token operator">+=</span> input<span class="token punctuation">[</span><span class="token punctuation">[</span>x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> y <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

            pixel_value <span class="token operator">+=</span> input<span class="token punctuation">[</span><span class="token punctuation">[</span>x <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> y<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            pixel_value <span class="token operator">+=</span> input<span class="token punctuation">[</span><span class="token punctuation">[</span>x<span class="token punctuation">,</span> y<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            pixel_value <span class="token operator">+=</span> input<span class="token punctuation">[</span><span class="token punctuation">[</span>x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> y<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

            pixel_value <span class="token operator">+=</span> input<span class="token punctuation">[</span><span class="token punctuation">[</span>x <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            pixel_value <span class="token operator">+=</span> input<span class="token punctuation">[</span><span class="token punctuation">[</span>x<span class="token punctuation">,</span> y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            pixel_value <span class="token operator">+=</span> input<span class="token punctuation">[</span><span class="token punctuation">[</span>x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

            output<span class="token punctuation">[</span><span class="token punctuation">[</span>x<span class="token punctuation">,</span> y<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> pixel_value <span class="token operator">/</span> <span class="token number">9.0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    output
<span class="token punctuation">}</span>
</code></pre></div><p><a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=ed5a8cbe8cfab762c32466c551957810" target="_blank" rel="noopener noreferrer">在线示例<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>我想你的心里已经有答案了吧。</p> <h2 id="不会用模式匹配"><a href="#不会用模式匹配" class="header-anchor">#</a> 不会用模式匹配</h2> <p>让我们回到一开始的 <code>IndexOf()</code> 函数，我们用 <code>Option</code> 类型举了一个很好的例子，先看下原始代码：</p> <div class="language-c# extra-class"><pre class="language-text"><code>int index = sentence.IndexOf(&quot;fox&quot;);

if (index != -1)
{
  string wordsAfterFox = sentence.SubString(index);
  Console.WriteLine(wordsAfterFox);
}
</code></pre></div><p>然后，你可能会看到这样的 Rust 代码：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> opt<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span>_<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">...</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> opt<span class="token punctuation">.</span><span class="token function">is_some</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> value <span class="token operator">=</span> opt<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>或者这样的：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> list<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token keyword">f32</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">...</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token operator">!</span>list<span class="token punctuation">.</span><span class="token function">is_empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> first <span class="token operator">=</span> list<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这些条件语句都在避免某些边界条件，不过就像之前说到的哨兵值一样，我们在重构的时候依然会极有可能引入 bug。</p> <p>而使用 Rust 的模式匹配，你可以保证当且仅当值有效时才会执行到对应的代码：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">=</span> opt <span class="token punctuation">{</span>
  <span class="token punctuation">...</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token punctuation">[</span>first<span class="token punctuation">,</span> <span class="token punctuation">..</span><span class="token punctuation">]</span> <span class="token operator">=</span> list <span class="token punctuation">{</span>
  <span class="token punctuation">...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>相比于之前的代码，由于避免了 <code>opt.unwrap()</code> 和 <code>list[index]</code>，模式匹配可以有更好的性能（作者的一点忠告：不要在网上听风就是雨，如果你真的想知道真相，建议写个 Benchmark 验证下）。</p> <h2 id="别再构造函数后初始化"><a href="#别再构造函数后初始化" class="header-anchor">#</a> 别再构造函数后初始化</h2> <p>许多语言都会在构造对象后调用对应的初始化函数（<code>init()</code> 之类的），但这有悖于 Rust 的约定：让无效状态不可见。</p> <p>假设你在写个 NLP 程序，需要加载一个包含所有关键词的词表：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> <span class="token keyword">mut</span> dict <span class="token operator">=</span> <span class="token class-name">Dictionary</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 读取文件并且把值存到哈希表或者列表里</span>
dict<span class="token punctuation">.</span><span class="token function">load_from_file</span><span class="token punctuation">(</span><span class="token string">&quot;./words.txt&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
</code></pre></div><p>然而，如果这么写了，意味着 <code>Dictionary</code> 类有两个状态：空的和满的。</p> <p>那么如果后续代码假设 <code>Dictionary</code> 有值，并且直接使用它，那当我们错误地对一个空状态的 <code>Dictionary</code> 进行索引时，就会造成 panic。</p> <p>在 Rust 中，最好在构造时就对结构体进行初始化，来避免结构体的空状态。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> dict <span class="token operator">=</span> <span class="token class-name">Dictionary</span><span class="token punctuation">::</span><span class="token function">from_file</span><span class="token punctuation">(</span><span class="token string">&quot;./words.txt&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

<span class="token keyword">impl</span> <span class="token class-name">Dictionary</span> <span class="token punctuation">{</span>
  <span class="token keyword">fn</span> <span class="token function-definition function">from_file</span><span class="token punctuation">(</span>filename<span class="token punctuation">:</span> <span class="token keyword">impl</span> <span class="token class-name">AsRef</span><span class="token operator">&lt;</span><span class="token class-name">Path</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token punctuation">,</span> <span class="token class-name">Error</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> text <span class="token operator">=</span> <span class="token namespace">std<span class="token punctuation">::</span>fs<span class="token punctuation">::</span></span><span class="token function">read_to_string</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> words <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> line <span class="token keyword">in</span> text<span class="token punctuation">.</span><span class="token function">lines</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      words<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token class-name">Dictionary</span> <span class="token punctuation">{</span> words <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>Dictionary::from_file()</code> 直接执行了初始化操作，并返回了初始化后的、立即可用的结构体，从而避免了上述问题。</p> <p>当然，遇到这种问题的频率因人而异，完全取决于你的编码经验和代码风格。</p> <p>一般来讲，函数式语言强调不可变性，所以函数式语言的使用者会天然地掌握这个经验。毕竟当你不能随便改变某个值时，你也不大可能创建一个初始化了一半的变量，然后再用什么其他值去填满它。</p> <p>但面向对象的语言就不太一样了，它可能更鼓励你先构造个空对象，然后再调用具体函数初始化它，毕竟对象引用很容易为 <code>null</code>，而且他们也不关心什么可变性之类的玩意儿……现在你知道为啥那些面向对象语言会经常由于 <code>NullPointerException</code> 崩溃了吧。</p> <h2 id="保护性拷贝"><a href="#保护性拷贝" class="header-anchor">#</a> 保护性拷贝</h2> <p>不可变对象的一个显而易见的优点时，你永远可以相信它不会发生变化，而放心地使用它的值。但某些语言，比如 Python 或者 Java，不可变性没有传递性。举个例子，<code>x</code> 是个不可变对象，<code>x.y</code> 却不一定是不可变的，除非显式地定义它的可变性。</p> <p>这意味着会出现下面的 Python 代码：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">ImmutablePerson</span><span class="token punctuation">:</span>
  <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> age<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> addresses<span class="token punctuation">:</span> List<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    self<span class="token punctuation">.</span>_name <span class="token operator">=</span> name
    self<span class="token punctuation">.</span>_age <span class="token operator">=</span> age
    self<span class="token punctuation">.</span>_addresses <span class="token operator">=</span> addresses

  <span class="token comment"># 只读属性</span>
  <span class="token decorator annotation punctuation">@property</span>
  <span class="token keyword">def</span> <span class="token function">name</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">return</span> self<span class="token punctuation">.</span>_name
  <span class="token decorator annotation punctuation">@property</span>
  <span class="token keyword">def</span> <span class="token function">age</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">return</span> self<span class="token punctuation">.</span>_age
  <span class="token decorator annotation punctuation">@property</span>
  <span class="token keyword">def</span> <span class="token function">addresses</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">return</span> self<span class="token punctuation">.</span>_addresses
</code></pre></div><p>后来其他人用了这个号称不可变的 <code>ImmutablePerson</code>，但是却不小心把它搞乱了：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">send_letters</span><span class="token punctuation">(</span>message<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> addresses<span class="token punctuation">:</span> List<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token comment"># 注意：发信 api 只接受大写字母，所以这里要预处理</span>
  <span class="token keyword">for</span> i<span class="token punctuation">,</span> address <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>addresses<span class="token punctuation">)</span><span class="token punctuation">:</span>
    addresses<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> addresses<span class="token punctuation">.</span>upper<span class="token punctuation">(</span><span class="token punctuation">)</span>

  client <span class="token operator">=</span> PostOfficeClient<span class="token punctuation">(</span><span class="token punctuation">)</span>
  client<span class="token punctuation">.</span>send_bulk_mail<span class="token punctuation">(</span>message<span class="token punctuation">,</span> addresses<span class="token punctuation">)</span>


person <span class="token operator">=</span> ImmutablePerson<span class="token punctuation">(</span><span class="token string">&quot;Joe Bloggs&quot;</span><span class="token punctuation">,</span> <span class="token number">42</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&quot;123 Fake Street&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

send_letters<span class="token punctuation">(</span>
  <span class="token string-interpolation"><span class="token string">f&quot;Dear </span><span class="token interpolation"><span class="token punctuation">{</span>person<span class="token punctuation">.</span>name<span class="token punctuation">}</span></span><span class="token string">, I Nigerian prince. Please help me moving my monies.&quot;</span></span><span class="token punctuation">,</span>
  person<span class="token punctuation">.</span>addresses
<span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>person<span class="token punctuation">.</span>addresses<span class="token punctuation">)</span> <span class="token comment"># [&quot;123 FAKE STREET&quot;]</span>
</code></pre></div><p>我承认，这个例子确实有点刻意了，但是修改一个函数的传参却非常常见（译者按：尤其在某些深度学习项目里）。当你知道你自己定义的 <code>ImmutablePerson</code> 的 <code>addresses</code> 属性不可变时，不会有什么大问题，但是当你和别人协作，而且别人还不知道 <code>addresses</code> 不可变时，那就出大问题了。</p> <p>事情也不是无法挽回，解决这个问题的经典方法是，总是在获取属性值的时候，返回它的拷贝，而非它自己：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">ImmutablePerson</span><span class="token punctuation">:</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  <span class="token decorator annotation punctuation">@property</span>
  <span class="token keyword">def</span> <span class="token function">addresses</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">return</span> self<span class="token punctuation">.</span>_addresses<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>这样就可以保证别人在使用该对象的属性时，不会意外改变它的原始值。</p> <p>考虑到这篇文章的主题是 Rust，你可能已经猜到了造成这种问题的根本原因：别名与可变性。</p> <p>并且你也可能想到，这种情况不会发生在 Rust 中，生命周期机制以及“有且只能有一处可变引用”的机制，保证了程序员无法在取得变量的所有权情况下去改动它的值，也没法显式地使用 <code>std::sync::Mutex&lt;T&gt;</code> 去改变某个共享引用值。</p> <blockquote><p>备注：你可能见过别人用 <code>.clone()</code> 来处理借用检查器的报错，然后就大喊“你看，Rust 还不是强迫我们做了保护性拷贝措施？”。我想说的是，这种代码基本都是由于程序员不熟悉生命周期机制，或者代码设计有问题导致的。</p></blockquote> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>本文并不能覆盖所有的最差实践，有些是因为我没亲身经历过，有些则是由于没法给出精简的例子。</p> <p>衷心地感谢回复我在 Rust 论坛发布的<a href="https://users.rust-lang.org/t/common-newbie-mistakes-or-bad-practices/64821/8" target="_blank" rel="noopener noreferrer">这个帖子<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>的各位同仁，尽管帖子的最后有点跑偏，各位 Rust 老鸟的论战还是让我受益颇深。</p></div></div> <!----></div> <div class="footer" data-v-3ef679b5><div class="footer-content page" data-v-3ef679b5><div class="left" data-v-3ef679b5><div class="footer-title" data-v-3ef679b5>FRIEND LINKS</div> <div class="links footer-text" data-v-3ef679b5></div> <div class="footer-text" data-v-3ef679b5><span id="busuanzi_container_site_pv" class="footer-count" data-v-3ef679b5><span id="busuanzi_value_site_pv" data-v-3ef679b5></span> <span id="busuanzi_value_site_uv" data-v-3ef679b5></span></span> <div class="counter" data-v-3ef679b5><div class="counter-title" data-v-3ef679b5>PAGE VIEWS</div> <div class="counter-content" data-v-3ef679b5><span class="counter-number" data-v-3ef679b5>0</span><span class="counter-number" data-v-3ef679b5>0</span><span class="counter-number" data-v-3ef679b5>0</span><span class="counter-number" data-v-3ef679b5>0</span><span class="counter-number" data-v-3ef679b5>0</span></div></div> <div class="counter" data-v-3ef679b5><div class="counter-title" data-v-3ef679b5>USER VIEWS</div> <div class="counter-content" data-v-3ef679b5><span class="counter-number" data-v-3ef679b5>0</span><span class="counter-number" data-v-3ef679b5>0</span><span class="counter-number" data-v-3ef679b5>0</span><span class="counter-number" data-v-3ef679b5>0</span><span class="counter-number" data-v-3ef679b5>0</span></div></div></div> </div> <div class="right" data-v-3ef679b5><div class="footer-title power" data-v-3ef679b5>POWERED BY</div> <a href="https://github.com/Yidadaa/Issue-Blog-With-Github-Action" class="logo" data-v-3ef679b5>ISSUE BLOG</a></div></div></div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.5abd99d6.js" defer></script><script src="/assets/js/11.05d3e33d.js" defer></script><script src="/assets/js/4.75c217d6.js" defer></script><script src="/assets/js/8.cabf8971.js" defer></script><script src="/assets/js/36.5ceb42fc.js" defer></script><script src="/assets/js/3.62f894e9.js" defer></script>
  </body>
</html>
